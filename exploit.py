import subprocess
import time
import os

import AccessPoint

def bToString(arg):
	return ''.join(map(chr,arg))

attackMode = 1
#0 is pasive, 1 is active

#subprocess.check_output(['sudo', 'ifconfig','wlan0','down'])
wifiInterfaces = (bToString(subprocess.check_output(['sudo','airmon-ng'])))
wifiInterfaces = (wifiInterfaces.split("\n"))
for i in range (2,len(wifiInterfaces)):
    if(wifiInterfaces[i].__contains__("9271")):
       interface = wifiInterfaces[i].split("\t")
       interface = interface[1]
       break
print("Placing interface: " +interface+" into monitor mode")
#subprocess.check_output(['sudo', 'airmon-ng','check','kill'])
try:
	statusCheck = bToString(subprocess.check_output(['sudo', 'airmon-ng','start',interface]))
	if(statusCheck.__contains__("ERROR")):
		print("Error starting module, process terminating")
		exit(0)
except subprocess.CalledProcessError as e:
	print(e)
	print("Error starting module, process terminating")
	exit(0)
	
interface = interface +"mon"
print("Monitor mode started, interface now: "+ interface)
subprocess.Popen(['sudo','timeout','10','airodump-ng','--ignore-negative-one','-w','dumpFile','--output-format','csv',interface])
time.sleep(11)
print("AP monitoring finished")
dumpFile = open("dumpFile-01.csv","r")
data = dumpFile.readlines()
dumpFile.close()
accessPoints = []
for i in range(2,len(data)):
	if(data[i] != "" or data[i] != "\n"):
		splitData = data[i].split(',')
		if(len(splitData) > 1 and splitData[0] != 'Station MAC'):
			accessPoints.append(AccessPoint.AccessPoint(splitData))
		elif(splitData[0] == 'Station MAC'):
			break
for each in accessPoints:
	if(each.getSSID().__contains__("SKY")):
		target = each
		if(attackMode == 0):
			#passive attack
			pass
		else:
			print(target.getMAC())
			print(target.getChannel())
			
			subprocess.Popen(['sudo','timeout','10','airodump-ng','--ignore-negative-one','--bssid', target.getMAC(), '-c', target.getChannel(),'-w','targetConnections','--output-format','csv',interface])
			time.sleep(11)
			targetConnection = open("targetConnections-01.csv","r")
			targetConnections = targetConnection.readlines()
			targetConnection.close()
			print(targetConnections)
			os.remove("targetConnections-01.csv")	



subprocess.check_output(['sudo','airmon-ng','stop',interface])
os.remove("dumpFile-01.csv")
print("Program over")
#subprocess.check_output(['sudo', 'ifconfig','wlan0','up'])

